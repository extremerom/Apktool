name: Compile and Sign APK

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL with decompiled APK (e.g., https://github.com/username/repo)'
        required: true
        type: string
      quiet:
        description: 'Suppress normal output (-q/--quiet)'
        required: false
        type: boolean
        default: false
      verbose:
        description: 'Increase output verbosity (-v/--verbose)'
        required: false
        type: boolean
        default: false
      force:
        description: 'Skip changes detection and build all files (-f/--force)'
        required: false
        type: boolean
        default: false
      jobs:
        description: 'Number of jobs to execute in parallel (-j/--jobs)'
        required: false
        type: string
        default: ''
      lib:
        description: 'Use shared library package:file, comma-separated for multiple (-l/--lib)'
        required: false
        type: string
        default: ''
      no_apk:
        description: 'Disable repacking into APK (--no-apk)'
        required: false
        type: boolean
        default: false
      shorten_res_paths:
        description: 'Shorten resource paths (-srp/--shorten-res-paths)'
        required: false
        type: boolean
        default: false
      enable_sparse_encoding:
        description: 'Enable sparse encoding (-ese/--enable-sparse-encoding)'
        required: false
        type: boolean
        default: false
      collapse_res_names:
        description: 'Collapse resource names (-crn/--collapse-res-names)'
        required: false
        type: boolean
        default: false
      no_crunch:
        description: 'Disable resource file crunching (--no-crunch)'
        required: false
        type: boolean
        default: false
      copy_original:
        description: 'Copy original AndroidManifest.xml and META-INF (--copy-original)'
        required: false
        type: boolean
        default: false
      debuggable:
        description: 'Set android:debuggable to true (--debuggable)'
        required: false
        type: boolean
        default: false
      net_sec_conf:
        description: 'Add network security configuration (--net-sec-conf)'
        required: false
        type: boolean
        default: false
      aapt:
        description: 'Path to custom aapt2 binary (--aapt)'
        required: false
        type: string
        default: ''

jobs:
  compile-and-sign:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout apktool repository
        uses: actions/checkout@v6

      - name: Setup zram for additional memory
        run: |
          echo "Setting up zram for compressed swap..."
          # Install zram-config if not available
          sudo apt-get update -qq
          # Configure zram to use 8GB of compressed RAM
          sudo apt install linux-modules-extra-$(uname -r) zram-tools -y
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.0

      - name: Build apktool
        run: ./gradlew build shadowJar proguard

      - name: Setup apktool script
        run: |
          # Find the built apktool jar (the proguard output, excluding other jars)
          JAR_PATH=$(find brut.apktool/apktool-cli/build/libs -name "apktool-*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" -not -name "*-all.jar" | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "Error: Could not find apktool jar"
            exit 1
          fi
          echo "Found apktool jar at: $JAR_PATH"

          # Copy the jar to the script directory and rename it
          cp "$JAR_PATH" scripts/linux/apktool.jar

          # Make the apktool script executable
          chmod +x scripts/linux/apktool

          # Add the script directory to PATH
          echo "$GITHUB_WORKSPACE/scripts/linux" >> $GITHUB_PATH

          # Verify setup
          ls -la scripts/linux/
          echo "Apktool script configured in PATH"

      - name: Download Samsung framework
        run: |
          echo "Downloading Samsung dm2q framework..."
          curl -L -o framework-dm2q.apk "https://gitlab.com/Eduardob3677/samsung_dm2q_dump/-/raw/dm2qxxx-user-16-BP2A.250605.031.A3-S916BXXS8EYK2-release-keys/system/system/framework/framework-res.apk"
          if [ ! -f framework-dm2q.apk ]; then
            echo "Error: Failed to download framework"
            exit 1
          fi
          echo "Framework downloaded successfully"
          ls -lh framework-dm2q.apk

      - name: Install framework with dm2q tag
        run: |
          echo "Creating framework directory..."
          mkdir -p apktool-frameworks
          echo "Installing framework with tag dm2q to apktool-frameworks..."
          apktool if framework-dm2q.apk -t dm2q -p apktool-frameworks
          echo "Framework installed successfully with tag dm2q"

      - name: Clone decompiled repository
        run: |
          echo "Cloning repository: ${{ github.event.inputs.repo_url }}"
          git clone "${{ github.event.inputs.repo_url }}" decompiled
          if [ ! -d decompiled ]; then
            echo "Error: Failed to clone repository"
            exit 1
          fi
          echo "Repository cloned successfully"
          ls -la decompiled/

      - name: Extract package name
        id: package-name
        run: |
          # Extract package name from AndroidManifest.xml
          if [ -f decompiled/AndroidManifest.xml ]; then
            PACKAGE=$(grep -oP 'package="\K[^"]+' decompiled/AndroidManifest.xml | head -n 1)
            if [ -z "$PACKAGE" ]; then
              echo "Error: Could not extract package name"
              exit 1
            fi
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "Package: $PACKAGE"
          else
            echo "Error: AndroidManifest.xml not found"
            exit 1
          fi

      - name: Compile APK
        run: |
          echo "Compiling APK with dm2q framework..."
          # Build apktool command with optional parameters using array
          CMD=(apktool b decompiled -p apktool-frameworks -o compiled.apk)
          
          # Check mutual exclusivity of quiet and verbose flags
          if [ "${{ github.event.inputs.quiet }}" = "true" ] && [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            echo "Error: quiet and verbose flags are mutually exclusive"
            exit 1
          fi
          
          # Add optional quiet flag
          if [ "${{ github.event.inputs.quiet }}" = "true" ]; then
            CMD+=(-q)
            echo "Using quiet mode (-q)"
          fi
          
          # Add optional verbose flag
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            CMD+=(-v)
            echo "Using verbose mode (-v)"
          fi
          
          # Add optional force flag
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            CMD+=(-f)
            echo "Using force mode (-f)"
          fi
          
          # Add optional jobs parameter with validation
          if [ -n "${{ github.event.inputs.jobs }}" ]; then
            # Validate that jobs is a non-negative integer (0 means auto-detect)
            if ! [[ "${{ github.event.inputs.jobs }}" =~ ^[0-9]+$ ]]; then
              echo "Error: jobs must be a non-negative integer (0 for auto-detect)"
              exit 1
            fi
            CMD+=(-j "${{ github.event.inputs.jobs }}")
            if [ "${{ github.event.inputs.jobs }}" = "0" ]; then
              echo "Using auto-detect for parallel jobs"
            else
              echo "Using ${{ github.event.inputs.jobs }} parallel jobs"
            fi
          fi
          
          # Add optional lib parameter (can be multiple, comma-separated) with validation
          if [ -n "${{ github.event.inputs.lib }}" ]; then
            IFS=',' read -ra LIBS <<< "${{ github.event.inputs.lib }}"
            for lib in "${LIBS[@]}"; do
              # Trim whitespace
              lib=$(echo "$lib" | xargs)
              # Validate format: package:file and prevent path traversal
              if ! [[ "$lib" =~ ^[a-zA-Z0-9._-]+:[a-zA-Z0-9._/-]+$ ]]; then
                echo "Error: lib format must be package:file (got: $lib)"
                exit 1
              fi
              # Check for path traversal sequences
              if [[ "$lib" == *".."* ]]; then
                echo "Error: lib path cannot contain '..' sequences"
                exit 1
              fi
              CMD+=(-l "$lib")
              echo "Using shared library: $lib"
            done
          fi
          
          # Add optional no-apk flag
          if [ "${{ github.event.inputs.no_apk }}" = "true" ]; then
            CMD+=(--no-apk)
            echo "Disabling APK repacking (--no-apk)"
          fi
          
          # Add optional shorten-res-paths flag
          if [ "${{ github.event.inputs.shorten_res_paths }}" = "true" ]; then
            CMD+=(--shorten-res-paths)
            echo "Shortening resource paths (--shorten-res-paths)"
          fi
          
          # Add optional enable-sparse-encoding flag
          if [ "${{ github.event.inputs.enable_sparse_encoding }}" = "true" ]; then
            CMD+=(--enable-sparse-encoding)
            echo "Enabling sparse encoding (--enable-sparse-encoding)"
          fi
          
          # Add optional collapse-res-names flag
          if [ "${{ github.event.inputs.collapse_res_names }}" = "true" ]; then
            CMD+=(--collapse-res-names)
            echo "Collapsing resource names (--collapse-res-names)"
          fi
          
          # Add optional no-crunch flag
          if [ "${{ github.event.inputs.no_crunch }}" = "true" ]; then
            CMD+=(--no-crunch)
            echo "Disabling resource crunching (--no-crunch)"
          fi
          
          # Add optional copy-original flag
          if [ "${{ github.event.inputs.copy_original }}" = "true" ]; then
            CMD+=(--copy-original)
            echo "Copying original files (--copy-original)"
          fi
          
          # Add optional debuggable flag
          if [ "${{ github.event.inputs.debuggable }}" = "true" ]; then
            CMD+=(--debuggable)
            echo "Setting android:debuggable to true (--debuggable)"
          fi
          
          # Add optional net-sec-conf flag
          if [ "${{ github.event.inputs.net_sec_conf }}" = "true" ]; then
            CMD+=(--net-sec-conf)
            echo "Adding network security configuration (--net-sec-conf)"
          fi
          
          # Add optional aapt parameter with validation
          if [ -n "${{ github.event.inputs.aapt }}" ]; then
            # Validate path format and prevent traversal
            aapt_path="${{ github.event.inputs.aapt }}"
            if [[ "$aapt_path" == *".."* ]]; then
              echo "Error: aapt path cannot contain '..' sequences"
              exit 1
            fi
            if [[ "$aapt_path" == /* ]] || [[ "$aapt_path" == ~* ]]; then
              echo "Error: aapt path must be a relative path"
              exit 1
            fi
            # Allow alphanumeric, dots, underscores, hyphens, slashes, and + for filenames
            if ! [[ "$aapt_path" =~ ^[a-zA-Z0-9._+/-]+$ ]]; then
              echo "Error: aapt path contains invalid characters"
              exit 1
            fi
            CMD+=(--aapt "$aapt_path")
            echo "Using custom aapt2 binary: $aapt_path"
          fi
          
          echo "Executing: ${CMD[@]}"
          "${CMD[@]}"
          
          if [ ! -f compiled.apk ]; then
            echo "Error: Compilation failed"
            exit 1
          fi
          echo "Compilation completed successfully"
          ls -lh compiled.apk

      - name: Decode keystore from secret
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "Error: KEYSTORE_BASE64 secret is not set"
            echo "Please configure the KEYSTORE_BASE64 secret in your repository settings"
            echo "To encode your keystore: base64 -w 0 your-keystore.jks"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          if [ ! -f keystore.jks ]; then
            echo "Error: Failed to decode keystore"
            exit 1
          fi
          echo "Keystore decoded successfully"

      - name: Install apksigner
        run: |
          # Install Android SDK command-line tools
          mkdir -p android-sdk/cmdline-tools
          cd android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          cd ../..

          # Accept licenses and install build-tools
          yes | android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          android-sdk/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"

          # Add to PATH
          echo "$(pwd)/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH

      - name: Align APK
        run: |
          echo "Aligning APK..."
          zipalign -v -p 4 compiled.apk compiled-aligned.apk
          if [ ! -f compiled-aligned.apk ]; then
            echo "Error: APK alignment failed"
            exit 1
          fi
          echo "APK aligned successfully"
          ls -lh compiled-aligned.apk

      - name: Sign APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "Signing APK..."

          # Validate that all required secrets are set
          if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "Error: KEYSTORE_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "$KEY_ALIAS" ]; then
            echo "Error: KEY_ALIAS secret is not set"
            exit 1
          fi
          if [ -z "$KEY_PASSWORD" ]; then
            echo "Error: KEY_PASSWORD secret is not set"
            exit 1
          fi

          apksigner sign --ks keystore.jks \
            --ks-pass pass:"$KEYSTORE_PASSWORD" \
            --key-pass pass:"$KEY_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --out signed.apk \
            compiled-aligned.apk

          if [ ! -f signed.apk ]; then
            echo "Error: APK signing failed"
            exit 1
          fi
          echo "APK signed successfully"
          ls -lh signed.apk

      - name: Verify APK signature
        run: |
          echo "Verifying APK signature..."
          apksigner verify --verbose signed.apk
          echo "âœ… APK signature verified successfully"

      - name: Rename APK with package name
        id: rename-apk
        run: |
          PACKAGE="${{ steps.package-name.outputs.package }}"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FINAL_NAME="${PACKAGE}_${TIMESTAMP}_signed.apk"
          mv signed.apk "$FINAL_NAME"
          echo "final_name=$FINAL_NAME" >> $GITHUB_OUTPUT
          echo "Final APK name: $FINAL_NAME"

      - name: Upload signed APK to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.package-name.outputs.package }}_signed
          path: ${{ steps.rename-apk.outputs.final_name }}
          retention-days: 30

      - name: Summary
        run: |
          echo "## Compilation and Signing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: ${{ steps.package-name.outputs.package }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Repository**: ${{ github.event.inputs.repo_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed APK**: ${{ steps.rename-apk.outputs.final_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APK compiled and signed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download the signed APK from the artifacts section above." >> $GITHUB_STEP_SUMMARY
