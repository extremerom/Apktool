name: Compile and Sign APK

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub repository URL with decompiled APK (e.g., https://github.com/username/repo)'
        required: true
        type: string
      quiet:
        description: 'Suppress normal output (-q/--quiet)'
        required: false
        type: boolean
        default: false
      verbose:
        description: 'Increase output verbosity (-v/--verbose)'
        required: false
        type: boolean
        default: false
      force:
        description: 'Skip changes detection and build all files (-f/--force)'
        required: false
        type: boolean
        default: false
      jobs:
        description: 'Number of jobs to execute in parallel (-j/--jobs)'
        required: false
        type: string
        default: ''
      lib:
        description: 'Use shared library package:file, comma-separated for multiple (-l/--lib)'
        required: false
        type: string
        default: ''
      no_apk:
        description: 'Disable repacking into APK (--no-apk)'
        required: false
        type: boolean
        default: false
      shorten_res_paths:
        description: 'Shorten resource paths (-srp/--shorten-res-paths)'
        required: false
        type: boolean
        default: false
      enable_sparse_encoding:
        description: 'Enable sparse encoding (-ese/--enable-sparse-encoding)'
        required: false
        type: boolean
        default: false
      collapse_res_names:
        description: 'Collapse resource names (-crn/--collapse-res-names)'
        required: false
        type: boolean
        default: false
      no_crunch:
        description: 'Disable resource file crunching (--no-crunch)'
        required: false
        type: boolean
        default: false
      copy_original:
        description: 'Copy original AndroidManifest.xml and META-INF (--copy-original)'
        required: false
        type: boolean
        default: false
      debuggable:
        description: 'Set android:debuggable to true (--debuggable)'
        required: false
        type: boolean
        default: false
      net_sec_conf:
        description: 'Add network security configuration (--net-sec-conf)'
        required: false
        type: boolean
        default: false
      aapt:
        description: 'Path to custom aapt2 binary (--aapt)'
        required: false
        type: string
        default: ''
      frame_tag:
        description: 'Use framework files tagged with specified tag (-t/--frame-tag)'
        required: false
        type: string
        default: 'dm2q'
      frame_path:
        description: 'Use framework files located in specified directory (-p/--frame-path)'
        required: false
        type: string
        default: 'apktool-frameworks'
      output_apk:
        description: 'Output the built apk to specified file (-o/--output)'
        required: false
        type: string
        default: 'compiled.apk'
      input_dir:
        description: 'Input directory containing decompiled APK files'
        required: false
        type: string
        default: 'decompiled'

jobs:
  compile-and-sign:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout apktool repository
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Build apktool from source
        run: |
          echo "Building apktool from source..."

          # Build apktool jar
          ./gradlew clean shadowJar

          # Create directory for apktool
          mkdir -p apktool-bin

          # Copy the built jar (shadowJar outputs to apktool-cli.jar)
          JAR_FILE="brut.apktool/apktool-cli/build/libs/apktool-cli.jar"
          if [ ! -f "$JAR_FILE" ]; then
            echo "Error: Could not find built apktool jar file at $JAR_FILE"
            exit 1
          fi
          echo "Found jar file: $JAR_FILE"
          cp "$JAR_FILE" apktool-bin/apktool.jar

          # Copy the wrapper script
          cp scripts/linux/apktool apktool-bin/apktool

          # Make the script executable
          chmod +x apktool-bin/apktool

          # Add to PATH
          echo "$GITHUB_WORKSPACE/apktool-bin" >> $GITHUB_PATH

          # Verify setup
          ls -la apktool-bin/
          echo "Apktool built and configured in PATH"

      - name: Verify apktool installation
        run: |
          # Test apktool in a new step where PATH is updated
          apktool --version

      - name: Download Samsung framework
        run: |
          echo "Downloading Samsung dm2q framework..."
          if ! curl -L -f -o framework-dm2q.apk "https://gitlab.com/Eduardob3677/samsung_dm2q_dump/-/raw/dm2qxxx-user-16-BP2A.250605.031.A3-S916BXXS8EYK2-release-keys/system/system/framework/framework-res.apk"; then
            echo "Error: Failed to download framework"
            exit 1
          fi
          if [ ! -f framework-dm2q.apk ] || [ ! -s framework-dm2q.apk ]; then
            echo "Error: Framework file is missing or empty"
            exit 1
          fi
          echo "Framework downloaded successfully"
          ls -lh framework-dm2q.apk

      - name: Install framework with tag
        run: |
          echo "Creating framework directory..."
          FRAME_PATH="${{ github.event.inputs.frame_path }}"
          FRAME_TAG="${{ github.event.inputs.frame_tag }}"
          mkdir -p "$FRAME_PATH"
          echo "Installing framework with tag $FRAME_TAG to $FRAME_PATH..."
          apktool if framework-dm2q.apk -t "$FRAME_TAG" -p "$FRAME_PATH"
          echo "Framework installed successfully with tag $FRAME_TAG"

      - name: Clone decompiled repository
        run: |
          INPUT_DIR="${{ github.event.inputs.input_dir }}"
          echo "Cloning repository: ${{ github.event.inputs.repo_url }}"
          if ! git clone "${{ github.event.inputs.repo_url }}" "$INPUT_DIR"; then
            echo "Error: Failed to clone repository"
            exit 1
          fi
          if [ ! -d "$INPUT_DIR" ]; then
            echo "Error: Input directory not found after clone"
            exit 1
          fi
          echo "Repository cloned successfully"
          ls -la "$INPUT_DIR"/

      - name: Extract package name
        id: package-name
        run: |
          INPUT_DIR="${{ github.event.inputs.input_dir }}"
          # Extract package name from AndroidManifest.xml
          if [ -f "$INPUT_DIR/AndroidManifest.xml" ]; then
            PACKAGE=$(grep -oP 'package="\K[^"]+' "$INPUT_DIR/AndroidManifest.xml" | head -n 1)
            if [ -z "$PACKAGE" ]; then
              echo "Error: Could not extract package name"
              exit 1
            fi
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "Package: $PACKAGE"
          else
            echo "Error: AndroidManifest.xml not found"
            exit 1
          fi

      - name: Compile APK
        run: |
          INPUT_DIR="${{ github.event.inputs.input_dir }}"
          FRAME_TAG="${{ github.event.inputs.frame_tag }}"
          FRAME_PATH="${{ github.event.inputs.frame_path }}"
          OUTPUT_APK="${{ github.event.inputs.output_apk }}"
          echo "Compiling APK with framework tag $FRAME_TAG..."
          # Build apktool command with optional parameters using array
          CMD=(apktool b "$INPUT_DIR" -p "$FRAME_PATH" -o "$OUTPUT_APK")

          # Check mutual exclusivity of quiet and verbose flags
          if [ "${{ github.event.inputs.quiet }}" = "true" ] && [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            echo "Error: quiet and verbose flags are mutually exclusive"
            exit 1
          fi

          # Add optional quiet flag
          if [ "${{ github.event.inputs.quiet }}" = "true" ]; then
            CMD+=(-q)
            echo "Using quiet mode (-q)"
          fi

          # Add optional verbose flag
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            CMD+=(-v)
            echo "Using verbose mode (-v)"
          fi

          # Add optional force flag
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            CMD+=(-f)
            echo "Using force mode (-f)"
          fi

          # Add optional jobs parameter with validation
          if [ -n "${{ github.event.inputs.jobs }}" ]; then
            # Validate that jobs is a non-negative integer (0 means auto-detect)
            if ! [[ "${{ github.event.inputs.jobs }}" =~ ^[0-9]+$ ]]; then
              echo "Error: jobs must be a non-negative integer (0 for auto-detect)"
              exit 1
            fi
            CMD+=(-j "${{ github.event.inputs.jobs }}")
            if [ "${{ github.event.inputs.jobs }}" = "0" ]; then
              echo "Using auto-detect for parallel jobs"
            else
              echo "Using ${{ github.event.inputs.jobs }} parallel jobs"
            fi
          fi

          # Add optional lib parameter (can be multiple, comma-separated) with validation
          if [ -n "${{ github.event.inputs.lib }}" ]; then
            IFS=',' read -ra LIBS <<< "${{ github.event.inputs.lib }}"
            for lib in "${LIBS[@]}"; do
              # Trim whitespace
              lib=$(echo "$lib" | xargs)
              # Validate format: package:file and prevent path traversal
              if ! [[ "$lib" =~ ^[a-zA-Z0-9._-]+:[a-zA-Z0-9._/-]+$ ]]; then
                echo "Error: lib format must be package:file (got: $lib)"
                exit 1
              fi
              # Check for path traversal sequences
              if [[ "$lib" == *".."* ]]; then
                echo "Error: lib path cannot contain '..' sequences"
                exit 1
              fi
              CMD+=(-l "$lib")
              echo "Using shared library: $lib"
            done
          fi

          # Add optional no-apk flag
          if [ "${{ github.event.inputs.no_apk }}" = "true" ]; then
            CMD+=(--no-apk)
            echo "Disabling APK repacking (--no-apk)"
          fi

          # Add optional shorten-res-paths flag
          if [ "${{ github.event.inputs.shorten_res_paths }}" = "true" ]; then
            CMD+=(--shorten-res-paths)
            echo "Shortening resource paths (--shorten-res-paths)"
          fi

          # Add optional enable-sparse-encoding flag
          if [ "${{ github.event.inputs.enable_sparse_encoding }}" = "true" ]; then
            CMD+=(--enable-sparse-encoding)
            echo "Enabling sparse encoding (--enable-sparse-encoding)"
          fi

          # Add optional collapse-res-names flag
          if [ "${{ github.event.inputs.collapse_res_names }}" = "true" ]; then
            CMD+=(--collapse-res-names)
            echo "Collapsing resource names (--collapse-res-names)"
          fi

          # Add optional no-crunch flag
          if [ "${{ github.event.inputs.no_crunch }}" = "true" ]; then
            CMD+=(--no-crunch)
            echo "Disabling resource crunching (--no-crunch)"
          fi

          # Add optional copy-original flag
          if [ "${{ github.event.inputs.copy_original }}" = "true" ]; then
            CMD+=(--copy-original)
            echo "Copying original files (--copy-original)"
          fi

          # Add optional debuggable flag
          if [ "${{ github.event.inputs.debuggable }}" = "true" ]; then
            CMD+=(--debuggable)
            echo "Setting android:debuggable to true (--debuggable)"
          fi

          # Add optional net-sec-conf flag
          if [ "${{ github.event.inputs.net_sec_conf }}" = "true" ]; then
            CMD+=(--net-sec-conf)
            echo "Adding network security configuration (--net-sec-conf)"
          fi

          # Add optional aapt parameter with validation
          if [ -n "${{ github.event.inputs.aapt }}" ]; then
            # Validate path format and prevent traversal
            aapt_path="${{ github.event.inputs.aapt }}"
            if [[ "$aapt_path" == *".."* ]]; then
              echo "Error: aapt path cannot contain '..' sequences"
              exit 1
            fi
            if [[ "$aapt_path" == /* ]] || [[ "$aapt_path" == ~* ]]; then
              echo "Error: aapt path must be a relative path"
              exit 1
            fi
            # Allow alphanumeric, dots, underscores, hyphens, slashes, and + for filenames
            if ! [[ "$aapt_path" =~ ^[a-zA-Z0-9._+/-]+$ ]]; then
              echo "Error: aapt path contains invalid characters"
              exit 1
            fi
            CMD+=(--aapt "$aapt_path")
            echo "Using custom aapt2 binary: $aapt_path"
          fi

          echo "Executing: ${CMD[@]}"
          "${CMD[@]}"

          OUTPUT_APK="${{ github.event.inputs.output_apk }}"
          if [ ! -f "$OUTPUT_APK" ]; then
            echo "Error: Compilation failed"
            exit 1
          fi
          echo "Compilation completed successfully"
          ls -lh "$OUTPUT_APK"

      - name: Decode keystore from secret
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "Error: KEYSTORE_BASE64 secret is not set"
            echo "Please configure the KEYSTORE_BASE64 secret in your repository settings"
            echo "To encode your keystore: base64 -w 0 your-keystore.jks"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          if [ ! -f keystore.jks ]; then
            echo "Error: Failed to decode keystore"
            exit 1
          fi
          echo "Keystore decoded successfully"

      - name: Install apksigner
        run: |
          # Install Android SDK command-line tools
          mkdir -p android-sdk/cmdline-tools
          cd android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          cd ../..

          # Accept licenses and install build-tools
          yes | android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          android-sdk/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"

          # Add to PATH
          echo "$(pwd)/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH

      - name: Align APK
        run: |
          OUTPUT_APK="${{ github.event.inputs.output_apk }}"
          ALIGNED_APK="${OUTPUT_APK%.apk}-aligned.apk"
          echo "Aligning APK..."
          zipalign -v -p 4 "$OUTPUT_APK" "$ALIGNED_APK"
          if [ ! -f "$ALIGNED_APK" ]; then
            echo "Error: APK alignment failed"
            exit 1
          fi
          echo "ALIGNED_APK=$ALIGNED_APK" >> $GITHUB_ENV
          echo "APK aligned successfully"
          ls -lh "$ALIGNED_APK"

      - name: Sign APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "Signing APK..."

          # Validate that all required secrets are set
          if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "Error: KEYSTORE_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "$KEY_ALIAS" ]; then
            echo "Error: KEY_ALIAS secret is not set"
            exit 1
          fi
          if [ -z "$KEY_PASSWORD" ]; then
            echo "Error: KEY_PASSWORD secret is not set"
            exit 1
          fi

          ALIGNED_APK="${{ env.ALIGNED_APK }}"
          apksigner sign --ks keystore.jks \
            --ks-pass pass:"$KEYSTORE_PASSWORD" \
            --key-pass pass:"$KEY_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --out signed.apk \
            "$ALIGNED_APK"

          if [ ! -f signed.apk ]; then
            echo "Error: APK signing failed"
            exit 1
          fi
          echo "APK signed successfully"
          ls -lh signed.apk

      - name: Verify APK signature
        run: |
          echo "Verifying APK signature..."
          apksigner verify --verbose signed.apk
          echo "âœ… APK signature verified successfully"

      - name: Rename APK with package name
        id: rename-apk
        run: |
          PACKAGE="${{ steps.package-name.outputs.package }}"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FINAL_NAME="${PACKAGE}_${TIMESTAMP}_signed.apk"
          mv signed.apk "$FINAL_NAME"
          echo "final_name=$FINAL_NAME" >> $GITHUB_OUTPUT
          echo "Final APK name: $FINAL_NAME"

      - name: Upload signed APK to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.package-name.outputs.package }}_signed
          path: ${{ steps.rename-apk.outputs.final_name }}
          retention-days: 30

      - name: Summary
        run: |
          echo "## Compilation and Signing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: ${{ steps.package-name.outputs.package }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Repository**: ${{ github.event.inputs.repo_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed APK**: ${{ steps.rename-apk.outputs.final_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APK compiled and signed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download the signed APK from the artifacts section above." >> $GITHUB_STEP_SUMMARY
