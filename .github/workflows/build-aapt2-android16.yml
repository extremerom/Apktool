name: Build aapt2_64 for Android 16

on:
  workflow_dispatch:
    inputs:
      apktool_branch:
        description: 'Apktool frameworks/base branch to use (e.g., apktool-16.0)'
        required: true
        default: 'apktool-16.0'
        type: string
      android_tag:
        description: 'AOSP tag/branch to use'
        required: true
        default: 'android-16-release'
        type: string

env:
  AOSP_BRANCH: ${{ inputs.android_tag }}
  APKTOOL_BRANCH: ${{ inputs.apktool_branch }}

jobs:
  build-linux-windows:
    name: Build aapt2_64 (Linux/Windows)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # This job requires a lot of disk space for AOSP
    # GitHub Actions runners have ~14GB available, but AOSP needs 150-250GB
    # This workflow is designed for self-hosted runners with sufficient disk space
    # or could be modified to use cloud storage
    
    steps:
      - name: Checkout Apktool repository
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: 17

      - name: Check disk space
        run: |
          echo "Disk space before:"
          df -h
          echo "AOSP requires 150-250GB of disk space"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev libc6-dev-i386 libncurses5 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev \
            libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
            python3 python-is-python3

      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Initialize AOSP repository
        run: |
          mkdir -p ~/aosp
          cd ~/aosp
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          repo init -u https://android.googlesource.com/platform/manifest \
            -b ${{ env.AOSP_BRANCH }} --partial-clone --depth=1

      - name: Sync AOSP repository (current branch only)
        run: |
          cd ~/aosp
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

      - name: Replace frameworks/base with modified version
        run: |
          cd ~/aosp/frameworks/base
          git remote add apktool https://github.com/iBotPeaches/platform_frameworks_base.git
          git fetch apktool ${{ env.APKTOOL_BRANCH }} --depth=1
          git checkout apktool/${{ env.APKTOOL_BRANCH }}

      - name: Build aapt2 for Linux/Windows
        run: |
          cd ~/aosp
          source build/envsetup.sh
          lunch aosp_cf_x86_64_only_phone-aosp_current-eng
          m aapt2

      - name: Strip binaries
        run: |
          cd ~/aosp
          strip out/host/linux-x86/bin/aapt2 || echo "Linux aapt2 not found"
          strip out/host/linux-x86/bin/aapt2_64 || echo "Linux aapt2_64 not found"
          strip out/host/windows-x86/bin/aapt2.exe || echo "Windows aapt2.exe not found"
          strip out/host/windows-x86/bin/aapt2_64.exe || echo "Windows aapt2_64.exe not found"

      - name: Verify binaries are static (Linux)
        run: |
          cd ~/aosp
          if [ -f out/host/linux-x86/bin/aapt2_64 ]; then
            echo "=== Linux aapt2_64 dependencies ==="
            ldd out/host/linux-x86/bin/aapt2_64 || echo "Static binary (no dependencies)"
          fi

      - name: Verify binaries are static (Windows)
        run: |
          cd ~/aosp
          if [ -f out/host/windows-x86/bin/aapt2_64.exe ]; then
            echo "=== Windows aapt2_64.exe dependencies ==="
            file out/host/windows-x86/bin/aapt2_64.exe
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v5
        with:
          name: aapt2-linux-android16
          path: |
            ~/aosp/out/host/linux-x86/bin/aapt2
            ~/aosp/out/host/linux-x86/bin/aapt2_64
          if-no-files-found: warn

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v5
        with:
          name: aapt2-windows-android16
          path: |
            ~/aosp/out/host/windows-x86/bin/aapt2.exe
            ~/aosp/out/host/windows-x86/bin/aapt2_64.exe
          if-no-files-found: warn

      - name: Show final disk space
        if: always()
        run: |
          echo "Disk space after:"
          df -h

  build-macos:
    name: Build aapt2_64 (macOS)
    runs-on: macos-latest
    permissions:
      contents: read
    # macOS builds require special SDK version patches
    # This job also requires significant disk space for AOSP
    
    steps:
      - name: Checkout Apktool repository
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: 17

      - name: Check disk space
        run: |
          echo "Disk space before:"
          df -h
          echo "AOSP requires 150-250GB of disk space"

      - name: Install dependencies
        run: |
          # Install Xcode command line tools if not already installed
          xcode-select --install || true
          
          # Install other required tools
          brew install coreutils

      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Initialize AOSP repository
        run: |
          mkdir -p ~/aosp
          cd ~/aosp
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          repo init -u https://android.googlesource.com/platform/manifest \
            -b ${{ env.AOSP_BRANCH }} --partial-clone --depth=1

      - name: Sync AOSP repository (current branch only)
        run: |
          cd ~/aosp
          repo sync -c -j$(sysctl -n hw.ncpu) --force-sync --no-clone-bundle --no-tags

      - name: Replace frameworks/base with modified version
        run: |
          cd ~/aosp/frameworks/base
          git remote add apktool https://github.com/iBotPeaches/platform_frameworks_base.git
          git fetch apktool ${{ env.APKTOOL_BRANCH }} --depth=1
          git checkout apktool/${{ env.APKTOOL_BRANCH }}

      - name: Apply macOS SDK version patch
        run: |
          cd ~/aosp
          
          # Find the current macOS SDK version
          SDK_PATH=$(find /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs -iname "*.sdk" | head -1)
          SDK_VERSION=$(basename "$SDK_PATH" | sed 's/MacOSX//; s/.sdk//')
          
          echo "Found macOS SDK version: $SDK_VERSION"
          
          # Patch the darwin_host.go file to include this SDK version
          DARWIN_CONFIG="build/soong/cc/config/darwin_host.go"
          
          if [ -f "$DARWIN_CONFIG" ]; then
            echo "Patching $DARWIN_CONFIG to support macOS SDK $SDK_VERSION"
            
            # Backup the original file
            cp "$DARWIN_CONFIG" "${DARWIN_CONFIG}.orig"
            
            # Add the SDK version to darwinSupportedSdkVersions array
            # Go allows trailing commas in arrays, so we can safely add it before the closing bracket
            sed -i.bak "/darwinSupportedSdkVersions/,/\]/ s/\]/\t\"$SDK_VERSION\",\n\t]/" "$DARWIN_CONFIG"
            
            echo "Patch applied. Showing diff:"
            diff "${DARWIN_CONFIG}.orig" "$DARWIN_CONFIG" || true
          else
            echo "Warning: $DARWIN_CONFIG not found"
          fi

      - name: Set ANDROID_JAVA_HOME
        run: |
          echo "ANDROID_JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

      - name: Build aapt2 for macOS
        run: |
          cd ~/aosp
          export ANDROID_JAVA_HOME=$JAVA_HOME
          source build/envsetup.sh
          lunch aosp_cf_x86_64_only_phone-aosp_current-eng
          m aapt2

      - name: Strip binary
        run: |
          cd ~/aosp
          strip out/host/darwin-x86/bin/aapt2_64 || echo "macOS aapt2_64 not found"

      - name: Verify binary is static
        run: |
          cd ~/aosp
          if [ -f out/host/darwin-x86/bin/aapt2_64 ]; then
            echo "=== macOS aapt2_64 dependencies ==="
            otool -L out/host/darwin-x86/bin/aapt2_64
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v5
        with:
          name: aapt2-macos-android16
          path: ~/aosp/out/host/darwin-x86/bin/aapt2_64
          if-no-files-found: warn

      - name: Show final disk space
        if: always()
        run: |
          echo "Disk space after:"
          df -h

  verify-and-package:
    name: Verify and Package All Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [build-linux-windows, build-macos]
    if: always()
    
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v5
        with:
          name: aapt2-linux-android16
          path: ./linux
        continue-on-error: true

      - name: Download Windows artifacts
        uses: actions/download-artifact@v5
        with:
          name: aapt2-windows-android16
          path: ./windows
        continue-on-error: true

      - name: Download macOS artifacts
        uses: actions/download-artifact@v5
        with:
          name: aapt2-macos-android16
          path: ./macos
        continue-on-error: true

      - name: List all downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find . -type f -name "aapt2*" -exec ls -lh {} \;

      - name: Create combined package
        run: |
          mkdir -p aapt2-android16/linux
          mkdir -p aapt2-android16/windows
          mkdir -p aapt2-android16/macos
          
          # Copy files if they exist
          cp -v linux/* aapt2-android16/linux/ 2>/dev/null || echo "No Linux binaries"
          cp -v windows/* aapt2-android16/windows/ 2>/dev/null || echo "No Windows binaries"
          cp -v macos/* aapt2-android16/macos/ 2>/dev/null || echo "No macOS binaries"
          
          # Create README
          cat > aapt2-android16/README.md << 'EOF'
          # aapt2 Binaries for Android 16
          
          These binaries were built from AOSP android-16-release with Apktool modifications.
          
          ## Contents
          
          - `linux/` - Linux binaries (aapt2, aapt2_64)
          - `windows/` - Windows binaries (aapt2.exe, aapt2_64.exe)
          - `macos/` - macOS binaries (aapt2_64)
          
          ## Verification
          
          These binaries should be statically linked. You can verify with:
          
          - Linux: `ldd aapt2_64` (should show "not a dynamic executable" or minimal dependencies)
          - macOS: `otool -L aapt2_64` (should show minimal system dependencies)
          - Windows: Use dependency walker or similar tools
          
          ## Usage
          
          Copy the appropriate binary to your Apktool installation:
          
          ```
          cp linux/aapt2_64 /path/to/apktool/prebuilt/linux/
          cp windows/aapt2_64.exe /path/to/apktool/prebuilt/windows/
          cp macos/aapt2_64 /path/to/apktool/prebuilt/macosx/
          ```
          
          ## Build Information
          
          - AOSP Branch: android-16-release
          - Modified frameworks/base: iBotPeaches/platform_frameworks_base
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          # Create tarball
          tar -czf aapt2-android16.tar.gz aapt2-android16/

      - name: Upload combined package
        uses: actions/upload-artifact@v5
        with:
          name: aapt2-android16-all-platforms
          path: aapt2-android16.tar.gz
          if-no-files-found: warn

      - name: Upload package contents
        uses: actions/upload-artifact@v5
        with:
          name: aapt2-android16-package
          path: aapt2-android16/
          if-no-files-found: warn
