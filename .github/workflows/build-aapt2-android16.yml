name: Build aapt2_64 for Android 16

on:
  workflow_dispatch:
    inputs:
      apktool_branch:
        description: 'Apktool frameworks/base branch to use (e.g., apktool-3.0.x)'
        required: true
        default: 'apktool-3.0.x'
        type: string
      android_tag:
        description: 'AOSP tag/branch to use'
        required: true
        default: 'android-16-release'
        type: string

env:
  AOSP_BRANCH: ${{ inputs.android_tag }}
  APKTOOL_BRANCH: ${{ inputs.apktool_branch }}

jobs:
  build-aapt2-and-apktool:
    name: Build aapt2_64 for Linux and Apktool
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # This job requires a lot of disk space for AOSP
    # GitHub Actions runners have ~14GB available, but AOSP needs 150-250GB
    # This workflow is designed for self-hosted runners with sufficient disk space
    # or could be modified to use cloud storage
    
    steps:
      - name: Checkout Apktool repository
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: 17

      - name: Check disk space
        run: |
          echo "Disk space before:"
          df -h
          echo "AOSP requires 150-250GB of disk space"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev libc6-dev-i386 libncurses5 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev \
            libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
            python3 python-is-python3

      - name: Install repo tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Initialize AOSP repository
        run: |
          mkdir -p ~/aosp
          cd ~/aosp
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          repo init -u https://android.googlesource.com/platform/manifest \
            -b ${{ env.AOSP_BRANCH }} --partial-clone --depth=1

      - name: Sync AOSP repository (current branch only)
        run: |
          cd ~/aosp
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

      - name: Replace frameworks/base with modified version
        run: |
          cd ~/aosp/frameworks/base
          git remote add apktool https://github.com/iBotPeaches/platform_frameworks_base.git
          git fetch apktool ${{ env.APKTOOL_BRANCH }} --depth=1
          git checkout apktool/${{ env.APKTOOL_BRANCH }}

      - name: Build aapt2 for Linux
        run: |
          cd ~/aosp
          source build/envsetup.sh
          lunch aosp_cf_x86_64_only_phone-aosp_current-eng
          m aapt2

      - name: Strip binaries
        run: |
          cd ~/aosp
          strip out/host/linux-x86/bin/aapt2 || echo "Linux aapt2 not found"
          strip out/host/linux-x86/bin/aapt2_64 || echo "Linux aapt2_64 not found"

      - name: Verify binaries are static
        run: |
          cd ~/aosp
          if [ -f out/host/linux-x86/bin/aapt2_64 ]; then
            echo "=== Linux aapt2_64 dependencies ==="
            ldd out/host/linux-x86/bin/aapt2_64 || echo "Static binary (no dependencies)"
          fi
          if [ -f out/host/linux-x86/bin/aapt2 ]; then
            echo "=== Linux aapt2 dependencies ==="
            ldd out/host/linux-x86/bin/aapt2 || echo "Static binary (no dependencies)"
          fi

      - name: Copy aapt2 binaries to Apktool prebuilt directory
        run: |
          mkdir -p /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux
          cp ~/aosp/out/host/linux-x86/bin/aapt2 /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux/aapt2
          cp ~/aosp/out/host/linux-x86/bin/aapt2_64 /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux/aapt2_64
          chmod +x /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux/aapt2
          chmod +x /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux/aapt2_64
          ls -lah /home/runner/work/Apktool/Apktool/brut.apktool/apktool-lib/src/main/resources/prebuilt/linux/

      - name: Build Apktool
        run: |
          cd /home/runner/work/Apktool/Apktool
          ./gradlew build shadowJar proguard -x test

      - name: Prepare release artifacts
        run: |
          mkdir -p /tmp/release
          # Copy aapt2 binaries
          cp ~/aosp/out/host/linux-x86/bin/aapt2 /tmp/release/aapt2
          cp ~/aosp/out/host/linux-x86/bin/aapt2_64 /tmp/release/aapt2_64
          # Copy Apktool jar
          cp /home/runner/work/Apktool/Apktool/brut.apktool/apktool-cli/build/libs/apktool-*.jar /tmp/release/ || echo "Apktool jar not found"
          ls -lah /tmp/release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-16-${{ github.run_number }}
          name: Apktool with aapt2_64 for Android 16 (Build ${{ github.run_number }})
          body: |
            Automated build of Apktool with aapt2_64 binaries for Android 16
            
            **Build Information:**
            - AOSP Branch: ${{ env.AOSP_BRANCH }}
            - Apktool Branch: ${{ env.APKTOOL_BRANCH }}
            - Build Number: ${{ github.run_number }}
            - Build Date: ${{ github.event.repository.updated_at }}
            
            **Files:**
            - `aapt2` - Linux aapt2 binary
            - `aapt2_64` - Linux aapt2_64 binary
            - `apktool-*.jar` - Apktool JAR file built with the new aapt2_64
          files: |
            /tmp/release/*
          draft: false
          prerelease: false
          token: ${{ secrets.TEST }}

      - name: Show final disk space
        if: always()
        run: |
          echo "Disk space after:"
          df -h

